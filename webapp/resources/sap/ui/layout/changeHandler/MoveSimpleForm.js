/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2016 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/fl/changeHandler/Base","sap/ui/fl/Utils"],function(q,B,U){"use strict";var M={};M.CHANGE_TYPE_MOVE_FIELD="moveSimpleFormField";M.CHANGE_TYPE_MOVE_GROUP="moveSimpleFormGroup";M.sTypeTitle="sap.ui.core.Title";M.sTypeToolBar="sap.m.Toolbar";M.sTypeLabel="sap.m.Label";M.CONTENT_AGGREGATION="content";M.applyChange=function(C,s,o,v){var e=C.getContent();var h=e.movedElements[0];var S=o.byId(e.selector.id);var j=o.getAggregation(S,M.CONTENT_AGGREGATION);if(e.changeType===M.CHANGE_TYPE_MOVE_FIELD){var k=o.byId(h.element);var l=j.indexOf(k);var n=G(o,j,l);var t=o.byId(h.target.groupId);var T=j.indexOf(t);var p=o.byId(h.source.groupId);var r=j.indexOf(p);var u=f(o,j,T,h.target.fieldIndex,(r===T)&&(h.source.fieldIndex<h.target.fieldIndex));var w=G(o,j,u);var x=j.slice();var F=x.slice(l,l+n);var y,z,D,E;if(l<u){y=x.slice(0,l);D=x.slice(l+n,u+w);E=x.slice(u+w,x.length);x=y.concat(D.concat(F.concat(E)));}else if(l>u){z=x.slice(0,u+w);D=x.slice(u+w,l);E=x.slice(l+n,x.length);x=z.concat(F.concat(D.concat(E)));}if(l!=u){o.removeAllAggregation(S,M.CONTENT_AGGREGATION);for(var i=0;i<x.length;++i){o.insertAggregation(S,M.CONTENT_AGGREGATION,x[i],i);}}}else if(e.changeType===M.CHANGE_TYPE_MOVE_GROUP){var H=[M.sTypeTitle,M.sTypeToolBar];var J=o.byId(h.element);var K=j.indexOf(J);var L=m(o,H,j,h.target.groupIndex);var t=j[L];var N=a(o,L,j,H);var O=a(o,K,j,H);var x=j.slice();x.splice(K,O);L=x.indexOf(t);var P=h.source.groupIndex<h.target.groupIndex?N:0;x=A(j,K,x,L+P,O);o.removeAllAggregation(S,M.CONTENT_AGGREGATION);for(var i=0;i<x.length;++i){o.insertAggregation(S,M.CONTENT_AGGREGATION,x[i],i);}}else{q.sap.log.warning("Unknown change type detected. Cannot apply to SimpleForm");}return true;};M.getInverseChange=function(C,s,o,v){return g(C);};M.completeChangeContent=function(C,s,o){var S=this.getSpecificChangeInfo(o,s);var e=C.getDefinition();e.selector=S.selector;e.content=S;};M.getSpecificChangeInfo=function(o,s){var e;var S=sap.ui.getCore().byId(s.semanticContainer);var h=s.movedElements;if(h.length>1){q.sap.log.warning("Moving more than 1 Formelement is not yet supported.");}var i=sap.ui.getCore().byId(h[0].id);var j=q.extend({},s.source);var t=q.extend({},s.target);if(!t.parent){t.parent=sap.ui.getCore().byId(t.id);}if(!j.parent){j.parent=sap.ui.getCore().byId(j.id);}if(S&&i&&t.parent){if(i instanceof sap.ui.layout.form.FormContainer){e=b(S,i,j,t);}else if(i instanceof sap.ui.layout.form.FormElement){e=d(S,i,j,t);}}else{q.sap.log.error("Element not found. This may caused by an instable id!");}return e;};var g=function(C){var r=q.extend(true,{},C);var R=r.getContent();R.movedElements.map(function(o,i){var t=q.extend(true,{},o.source);o.source=o.target;o.target=t;return o;});return r;};var m=function(o,s,C,e){var r;var h=-1;for(var i=0;i<C.length;i++){var t=o.getControlType(C[i]);if(s.indexOf(t)>-1){h++;if(h===e){r=C[i];break;}}}return C.indexOf(r);};var I=function(e,i){if(i>=e.length){return true;}var t=e[i].getMetadata().getName();return(M.sTypeTitle===t||M.sTypeToolBar===t);};var G=function(o,e,i){return a(o,i,e,[M.sTypeTitle,M.sTypeToolBar,M.sTypeLabel]);};var f=function(o,C,i,F,u){if(!I(C,i)){q.sap.log.error("Illegal argument. iIndex has to point to a title or toolbar");}else{F=u?F+1:F;var e=0;var h=i;var j;while(h<C.length&&e<F){++e;j=G(o,C,h);h+=j;}}return h;};var a=function(o,e,C,s){var i=0;for(i=e+1;i<C.length;++i){var t=o.getControlType(C[i]);if(s.indexOf(t)>-1){break;}}return i-e;};var A=function(s,S,t,T,e){var r=t;for(var i=0;i<e;i++){r.splice(T+i,0,s[S+i]);}return r;};var b=function(s,o,S,t){var e=c(o);var h=s.getId();var o={element:e.getId(),source:{groupIndex:S.index},target:{groupIndex:t.index}};return{changeType:M.CHANGE_TYPE_MOVE_GROUP,selector:{id:h},target:h,movedElements:[o]};};var c=function(h){var r=h.getTitle();if(!r){r=h.getToolbar();}return r;};var d=function(s,o,S,t){var e=s.getId();var l=o.getLabel().getId();var T=c(t.parent);var h=c(S.parent);var i=T.getId();var j=h.getId();var o={element:l,source:{groupId:j,fieldIndex:S.index},target:{groupId:i,fieldIndex:t.index}};return{changeType:M.CHANGE_TYPE_MOVE_FIELD,selector:{id:e},target:e,movedElements:[o]};};return M;},true);
