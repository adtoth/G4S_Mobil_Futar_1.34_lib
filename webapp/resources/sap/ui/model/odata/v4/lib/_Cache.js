/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2016 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","./_Helper","./_SyncPromise"],function(q,_,a){"use strict";var C;function b(M,p,i){if(i){if(!M[p]){M[p]=[i];}else if(M[p].indexOf(i)>=0){return;}else{M[p].push(i);}}}function c(Q,R,D){Object.keys(Q).forEach(function(K){var v=Q[K];if(D&&K[0]==='$'){return;}switch(K){case"$expand":v=C.convertExpand(v);break;case"$filter":case"$orderby":break;case"$select":if(Array.isArray(v)){v=v.join(",");}break;default:if(K[0]==='$'){throw new Error("Unsupported system query option "+K);}}R(K,v);});}function d(R,p,L){if(p){p.split("/").every(function(s){if(!R||typeof R!=="object"){L(s);R=undefined;return false;}R=R[s];if(R===undefined){L(s);return false;}return true;});}return R;}function f(A,v,s,E){var i;for(i=s;i<E;i++){A[i]=v;}}function e(i,p,o,n){var L,P;if(n&&typeof n==="object"){for(P in n){e(i,_.buildPath(p,P),o&&o[P],n[P]);}}else if(o&&typeof o==="object"){for(P in o){e(i,_.buildPath(p,P),o[P],undefined);}}else{L=i[p];if(L&&o!==n){L.forEach(function(s){s.onChange(n);});}}}function h(p,P){var R;for(R in p){if(g(R,P)){return true;}}return false;}function g(R,p){return p===""||R===p||R.indexOf(p+"/")===0;}function r(M,p,i){var I=M[p],n;if(I){n=I.indexOf(i);if(n>=0){if(I.length===1){delete M[p];}else{I.splice(n,1);}}}}function j(o){var i,p,P;for(p in o.mPatchRequests){P=o.mPatchRequests[p];for(i=0;i<P.length;i++){o.oRequestor.removePatch(P[i]);}}}function k(o,s,E,G){var n=o.aElements,p=E-s,P,R=o.sResourcePath+"$skip="+s+"&$top="+p;P=o.oRequestor.request("GET",R,G).then(function(t){var i,u=t.value.length,v;if(n!==o.aElements){v=new Error("Refresh canceled pending request: "+o.oRequestor.getServiceUrl()+R);v.canceled=true;throw v;}o.sContext=t["@odata.context"];if(u<p){o.iMaxElements=s+u;o.aElements.splice(o.iMaxElements,p-u);}for(i=0;i<u;i++){o.aElements[s+i]=t.value[i];}})["catch"](function(i){if(n===o.aElements){f(o.aElements,undefined,s,E);}throw i;});f(o.aElements,P,s,E);}function l(o,p){var i,R,P;for(R in o.mPatchRequests){if(g(R,p)){P=o.mPatchRequests[R];for(i=0;i<P.length;i++){o.oRequestor.removePatch(P[i]);}delete o.mPatchRequests[R];}}}function m(R,s,Q){var i=C.buildQueryString(Q);this.sContext=undefined;this.aElements=[];this.iMaxElements=-1;this.mChangeListeners={};this.mPatchRequests={};this.mQueryOptions=Q;this.oRequestor=R;this.sResourcePath=s+i+(i.length?"&":"?");}m.prototype.deregisterChange=function(i,p,L){if(arguments.length){r(this.mChangeListeners,i+"/"+p,L);}else{this.mChangeListeners={};}};m.prototype.hasPendingChanges=function(p){return h(this.mPatchRequests,p);};m.prototype.read=function(I,L,G,p,D,o){var i,E=I+L,n=-1,s=false,t=this;if(I<0){throw new Error("Illegal index "+I+", must be >= 0");}if(L<0){throw new Error("Illegal length "+L+", must be >= 0");}else if(L!==1&&p!==undefined){throw new Error("Cannot drill-down for length "+L);}if(this.iMaxElements>=0&&E>this.iMaxElements){E=this.iMaxElements;}for(i=I;i<E;i++){if(this.aElements[i]!==undefined){if(n>=0){k(this,n,i,G);s=true;n=-1;}}else if(n<0){n=i;}}if(n>=0){k(this,n,E,G);s=true;}if(s&&D){D();}return a.all(this.aElements.slice(I,E)).then(function(){var R;if(p!==undefined){b(t.mChangeListeners,I+"/"+p,o);R=t.aElements[I];return d(R,p,function(u){q.sap.log.error("Failed to drill-down into "+t.sResourcePath+"$skip="+I+"&$top=1 via "+p+", invalid segment: "+u,null,"sap.ui.model.odata.v4.lib._Cache");});}return{"@odata.context":t.sContext,value:t.aElements.slice(I,E)};});};m.prototype.refresh=function(){this.sContext=undefined;this.iMaxElements=-1;this.aElements=[];j(this);};m.prototype.resetChanges=function(p){l(this,p);};m.prototype.toString=function(){return this.oRequestor.getServiceUrl()+this.sResourcePath;};m.prototype.update=function(G,p,v,E,P){var i=this.mChangeListeners,s=P.split("/"),I=parseInt(s.shift(),10),t=this;return this.read(I,1,G,s.join("/")).then(function(R){var B={},H,o,n=P+"/"+p,u;if(!R){throw new Error("Cannot update '"+p+"': '"+P+"' does not exist");}E+=C.buildQueryString(t.mQueryOptions,true);H={"If-Match":R["@odata.etag"]};o=R[p];B[p]=R[p]=v;e(i,n,o,v);u=t.oRequestor.request("PATCH",E,G,H,B);b(t.mPatchRequests,n,u);return u.then(function(w){r(t.mPatchRequests,n,u);e(i,P,R,w);for(p in R){if(p in w){R[p]=w[p];}}return w;},function(w){r(t.mPatchRequests,n,u);if(w.canceled){e(i,n,R[p],o);R[p]=o;}throw w;});});};function S(R,s,Q,i,p){this.mChangeListeners={};this.mPatchRequests={};this.bPost=p;this.bPosting=false;this.oPromise=null;this.mQueryOptions=Q;this.oRequestor=R;this.sResourcePath=s+C.buildQueryString(Q);this.bSingleProperty=i;}S.prototype.deregisterChange=function(p,L){if(arguments.length){r(this.mChangeListeners,this.bSingleProperty?"value":p,L);}else{this.mChangeListeners={};}};S.prototype.hasPendingChanges=function(p){return h(this.mPatchRequests,p);};S.prototype.post=function(G,D,E){var t=this;if(!this.bPost){throw new Error("POST request not allowed");}if(this.bPosting){throw new Error("Parallel POST requests not allowed");}this.oPromise=a.resolve(this.oRequestor.request("POST",this.sResourcePath,G,{"If-Match":E},D).then(function(R){t.bPosting=false;return R;},function(o){t.bPosting=false;throw o;}));this.bPosting=true;return this.oPromise;};S.prototype.read=function(G,p,D,L){var t=this,P,R=this.sResourcePath;if(!this.oPromise){if(this.bPost){throw new Error("Read before a POST request");}P=a.resolve(this.oRequestor.request("GET",R,G).then(function(o){var E;if(t.oPromise!==P){E=new Error("Refresh canceled pending request: "+t);E.canceled=true;throw E;}return o;}));if(D){D();}this.oPromise=P;}return this.oPromise.then(function(o){if(t.bSingleProperty){o=o?o.value:null;}b(t.mChangeListeners,t.bSingleProperty?"value":p,L);if(p){return d(o,p,function(s){q.sap.log.error("Failed to drill-down into "+R+"/"+p+", invalid segment: "+s,null,"sap.ui.model.odata.v4.lib._Cache");});}return o;});};S.prototype.refresh=function(){if(this.bPost){throw new Error("Refresh not allowed when using POST");}this.oPromise=undefined;j(this);};S.prototype.resetChanges=function(p){l(this,p);};S.prototype.toString=function(){return this.oRequestor.getServiceUrl()+this.sResourcePath;};S.prototype.update=function(G,p,v,E,P){var t=this;return(this.bSingleProperty?this.oPromise:this.read(G,P)).then(function(R){var B={},H,o,s=t.bSingleProperty?"value":p,u=_.buildPath(P,s),U;if(!R){throw new Error("Cannot update '"+p+"': '"+P+"' does not exist");}E+=C.buildQueryString(t.mQueryOptions,true);H={"If-Match":R["@odata.etag"]};o=R[s];e(t.mChangeListeners,u,o,v);B[p]=R[s]=v;U=t.oRequestor.request("PATCH",E,G,H,B);b(t.mPatchRequests,u,U);return U.then(function(i){r(t.mPatchRequests,u,U);if(t.bSingleProperty){R.value=i[p];}else{e(t.mChangeListeners,P,R,i);for(p in R){if(p in i){R[p]=i[p];}}}return i;},function(i){r(t.mPatchRequests,u,U);if(i.canceled){e(t.mChangeListeners,u,R[s],o);R[s]=o;}throw i;});});};C={buildQueryString:function(Q,D){return _.buildQuery(C.convertQueryOptions(Q,D));},convertExpand:function(E){var R=[];if(!E||typeof E!=="object"){throw new Error("$expand must be a valid object");}Object.keys(E).forEach(function(s){var v=E[s];if(v&&typeof v==="object"){R.push(C.convertExpandOptions(s,v));}else{R.push(s);}});return R.join(",");},convertExpandOptions:function(E,v){var i=[];c(v,function(o,O){i.push(o+'='+O);});return i.length?E+"("+i.join(";")+")":E;},convertQueryOptions:function(Q,D){var i={};if(!Q){return undefined;}c(Q,function(K,v){i[K]=v;},D);return i;},create:function _create(R,s,Q){return new m(R,s,Q);},createSingle:function _createSingle(R,s,Q,i,p){return new S(R,s,Q,i,p);}};return C;},false);
