/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2016 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/Device'],function($,D){"use strict";var q=[],c={},t=-1,i,d;function a(C,o,d){if(window["sap-ui-debug"]){o.timeout=300;}var s=new Date();h();function h(){try{var r=C();}catch(j){d.reject(o);throw j;}if(r.result){b(d);return;}var k=new Date()-s;k/=1000;var p=Math.round(k%60);if(o.timeout>p){t=setTimeout(h,o.pollingInterval);return;}if(o.error){try{o.error(o,r.arguments);}finally{d.reject(o,r.arguments);}return;}d.reject(o);}}function b(h){var I=D.browser.msie?50:0;if(q.length===0){h.resolve();return true;}var j=q.shift();t=setTimeout(function(){a(j.callback,j.options,h);},I);}function e(p,n){var N=q.length-p;if(N){var h=q.splice(p,N);h.forEach(function(j){j.options._nestedIn=n;});q=h.concat(q);}}function f(h){h=(h||0)+2;if(D.browser.mozilla){h=h-1;}var E=new Error(),s=E.stack;if(!s){try{throw E();}catch(o){s=o.stack;}}if(!s){return"";}s=s.split("\n");s.splice(0,h);return s.join("\n");}function g(o){var r="\nCallstack:\n";if(o._stack){r+=o._stack;delete o._stack;}else{r+="Unknown";}if(o._nestedIn){r+=g(o._nestedIn);delete o._nestedIn;}return r;}var O=function(h){this.and=this;$.extend(this,h);};O.config={};O.extendConfig=function(o){["actions","assertions","arrangements"].forEach(function(A){if(!o[A]){return;}Object.keys(O.config[A]).forEach(function(k){if(!o[A][k]){o[A][k]=O.config[A][k];}});});O.config=$.extend(O.config,o);};O.resetConfig=function(){O.config={arrangements:new O(),actions:new O(),assertions:new O(),timeout:15,pollingInterval:400,_stackDropCount:0};};O.getContext=function(){return c;};O.emptyQueue=function emptyQueue(){d=$.Deferred();i=false;b(d);return d.promise().fail(function(o){q=[];if(i){o.errorMessage="Queue was stopped manually";o.errorMessage+=g({_stack:f(1)});}else{o.errorMessage=o.errorMessage||"Failed to wait for check";o.errorMessage+=g(o);}$.sap.log.error(o.errorMessage,"Opa");}).always(function(){t=-1;d=null;});};O.stopQueue=function stopQueue(h){var F=h!==false;q=[];if(!d){$.sap.log.warning("stopQueue was called before emptyQueue, queued tests have never been executed","Opa");}else{if(t!==-1){clearTimeout(t);}i=true;if(F){d.reject({});}else{d.resolve();}}};O.resetConfig();O.prototype={getContext:O.getContext,waitFor:function(o){var h=$.Deferred();o=$.extend({},O.config,o);o._stack=f(1+o._stackDropCount);delete o._stackDropCount;this._validateWaitFor(o);h.promise(this);q.push({callback:function(){var r=true;if(o.check){try{r=o.check.apply(this,arguments);}catch(j){$.sap.log.error(j.stack,"OPA encountered an error");h.reject(o);throw j;}}if(i){return{result:true,arguments:arguments};}if(r){if(o.success){var C=q.length;try{o.success.apply(this,arguments);}catch(j){$.sap.log.error(j.stack,"OPA encountered an error");h.reject(o);throw j;}finally{e(C,o);}}h.resolve();return{result:true,arguments:arguments};}return{result:false,arguments:arguments};}.bind(this),options:o});return this;},extendConfig:O.extendConfig,emptyQueue:O.emptyQueue,_validateWaitFor:function(p){if(p.error&&!$.isFunction(p.error)){throw new Error("sap.ui.test.Opa#waitFor - the 'error' parameter needs to be a function but '"+p.error+"' was passed");}}};return O;},true);
